const a0n=a0b;(function(a,b){const m=a0b,c=a();while(!![]){try{const d=parseInt(m(0x135))/0x1*(parseInt(m(0x157))/0x2)+parseInt(m(0x1af))/0x3*(-parseInt(m(0x14e))/0x4)+-parseInt(m(0x1d0))/0x5*(-parseInt(m(0x14f))/0x6)+parseInt(m(0x1df))/0x7+parseInt(m(0x1d3))/0x8+parseInt(m(0x186))/0x9+-parseInt(m(0x169))/0xa*(parseInt(m(0x1da))/0xb);if(d===b)break;else c['push'](c['shift']());}catch(e){c['push'](c['shift']());}}}(a0a,0x71ff8));import{readdir,stat,mkdir}from'fs/promises';import a0c from'path';import a0d from'chokidar';import{fileURLToPath,pathToFileURL}from'url';import a0e from'p-limit';import{info,error,warn,debug}from'../bookieutils/logger.js';import{hotReloadConfig}from'../bookieutils/config.js';const __dirname=a0c[a0n(0x14b)+'me'](fileURLToPath(import.meta[a0n(0x1ad)])),AUX_DIR=a0c[a0n(0x14a)+'ve'](__dirname,a0n(0x1b0)),CONCURRENCY_LIMIT=0x5,LOAD_TIMEOUT=0xbb8,RELOAD_DEBOUNCE=0xfa,ENV=process[a0n(0x12f)][a0n(0x18a)+a0n(0x1d9)]||a0n(0x141)+a0n(0x1a1)+'t';export const name=a0n(0x17f)+a0n(0x1cb);export const version=a0n(0x199);export const adminOnly=![];let modules=new Map(),messageHandlers=[],callbackHandlers=[];function a0a(){const F=['CYb1Cgq','CZOG','B3iGC2u','mI4WlJe','ChjVzhu','ignHBgW','igLUia','zsbYzwW','Aw5PDgK','zMLSDgu','ChvZAa','B3bTzw4','iokAOo+4JYbnBW','yMLUza','DhrSzwq','ywXPEMu','B2fK','AwXLzca','AhjLzG','igHHCYa','zgvSzxq','CMLUzYa','B2fKzwq','DxjS','C2fNzq','mZKYnZi0Efj5Afnt','lI9ZDwi','p3q9','yMfZzw4','DwXLihi','B25dywW','zgvZ','BM93','BgvUz3q','zYbMDwW','DhmGkgK','B2DYzxm','zwfUihu','ipcFLkuGq3i','zwXVywq','Bw9KDwW','ywDLoIa','ipcFMOaGsw4','ChjPB3i','B25nzxm','AgfZ','ihn1y2m','zhvSzxm','Aw5JBhu','ipcFKQuGsw4','y2XVC2u','BMCGiM4','B24GzMe','ywrLCG','ipcFKyaGv2e','Axr5','BgL6zs8','z2v0','mZi5nwzWshnWva','ywXSu2u','Aw4GChi','ntq3mJe3nMHft0DSyq','DMfSDwu','AxbWAw4','BMzPzY4','yMvMB3i','ANnVBIa','ru5w','mJjMDM5bB3a','Dg8Gy2W','yxj0Aw4','CMfJzq','y2HHBMC','mJe4mJyWmeDMCe5ksG','zNvSBca','ipcFKQqGvgu','AwXLzdO','zYbPBNy','uMvKywm','ipcFLiqGu3q','zwfKEsa','ipcFKQuGsge','uxvLCNK','yMfJAZO','BM8GDxm','zw52','ipcFL5hVUi8Gvw4','AxPHDgK','Dw5SAw4','yxrLzca','BIbJB20','mZLrBw55uhy','ztOG','ywrK','y3rPB24','AxPLza','BcbTB2q','y2XLyxi','B3iGzhu','DMvYC2K','zMfPBgu','ihrPBwu','Aw9U','zgv2zwW','yw1L','Bg9Hzgu','ywXS','C2fNzs8','igzVCIa','Bg9Hza','B3DU','zcbHBhi','CMvZB2W','zgLYBMe','AxrO','iokpSYbnBW','ohbcAhzTCW','mZKXoffMvMXzAq','DgvKigy','BwvZC2e','igfMDgu','4PYfieXVyq','ignI','yxjKB3C','4PM777IpifjLBa','mJi4nJzfDvrwBeC','zwvKzwq','igXVywq','BgfZDfi','BwLZC2K','Dg8G','ipcFK6yGtw8','ipcFLkCGsge','CMvWBge','y3vYAxq','BML0Awe','iokDJcbgyq','AxnZDwu','AxrPywW','zwqGB24','BMrSzxi','iokBLcbtAW','AM9PBG','ote3mda1mevYD0DTCa','zcbVDxq','C2v0','ig1LC3m','zgLUzYa','BwfW','A2v5CW','AxngAwW','D2f0y2G','ig1ZzYW','ywrLCJO','zw5KC1C','igzHAwW','C3rHDhu','lMPZ','BMCGiNy','zhvSzsa','y2XLyw4','BMfTzq','zwqG4OAsia','zvjLBg8','BgjHy2S','qxv4tg8','DgnOAw4','zNvSzMK','ihvWia','ywXPzca','zxHWB3i','AxrPy2e','nJiXnJuZng9oBxroEG','yw1LiG','CMvSB2e','CgXLDgu','tK9erv8','zxjZAw8','iokAOsbJBW','zNvUy3q','ipcFP7KGq2W','ywjSzsa','zgvK','zwfUzwq','BcbLCNi','C29YDa','C2H1Dgq','BgXLza'];a0a=function(){return F;};return a0a();}const concurrencyLimiter=a0e(CONCURRENCY_LIMIT),fileTimers=new Map();let isReloading=![],watcher=null,isInitialized=![];export const moduleStatus={'loaded':[],'failed':[],'lastReload':null};function sanitizeError(a){const o=a0n;if(ENV===o(0x19a)+o(0x138))return{'name':a[o(0x17b)],'message':a[o(0x151)+'ge'],'stack':o(0x128)+o(0x150)+o(0x198)+o(0x160)+'y'};return a;}function updateHandlers(){const p=a0n;messageHandlers=[],callbackHandlers=[];const a=[...modules[p(0x1d4)+'s']()][p(0x193)]((c,d)=>(d[p(0x1c1)+p(0x1cd)]??0x0)-(c[p(0x1c1)+p(0x1cd)]??0x0));for(const {mod:b}of a){typeof b[p(0x1c2)+p(0x1ae)]===p(0x18d)+p(0x140)&&messageHandlers[p(0x1a0)]({'handler':b[p(0x1c2)+p(0x1ae)][p(0x1a3)](b),'module':b[p(0x17b)]}),typeof b[p(0x1b4)+p(0x17e)+p(0x12c)]===p(0x18d)+p(0x140)&&callbackHandlers[p(0x1a0)]({'handler':b[p(0x1b4)+p(0x17e)+p(0x12c)][p(0x1a3)](b),'module':b[p(0x17b)]});}info(p(0x17f)+p(0x173)+p(0x15e)+p(0x166)+p(0x196)+p(0x133)+'-\x20'+messageHandlers[p(0x1b7)+'h']+(p(0x172)+'\x20')+callbackHandlers[p(0x1b7)+'h']+p(0x154));}function timeout(a,b,c){const q=a0n;return Promise[q(0x1dd)]([a,new Promise((d,e)=>{setTimeout(()=>{const r=a0b;e(new Error(r(0x17f)+r(0x173)+'\x20'+c+(r(0x13f)+r(0x16a)+r(0x152)+'r\x20')+b+'ms'));},b);})]);}function validateModule(a,b){const s=a0n,c=a[s(0x17b)]||b,d=[];if(!a[s(0x17b)])d[s(0x1a0)](s(0x15b)+s(0x1c9)+s(0x187));if(!a[s(0x13d)+'on'])d[s(0x1a0)](s(0x15b)+s(0x178)+s(0x18b)+'n\x22');!a[s(0x19e)+s(0x1a5)]&&!a[s(0x1c2)+s(0x1ae)]&&!a[s(0x1b4)+s(0x17e)+s(0x12c)]&&d[s(0x1a0)](s(0x12e)+s(0x18f)+s(0x184)+s(0x1b9)+s(0x161)+s(0x1ce)+s(0x1c2)+s(0x145)+s(0x1b4)+s(0x17e)+s(0x12c)+')');if(d[s(0x1b7)+'h'])return warn(s(0x17f)+s(0x173)+s(0x1a2)+s(0x179)+c+(s(0x1a9)+s(0x163)+s(0x197))+d[s(0x168)](',\x20')),![];return!![];}async function unloadModule(a,b=a0n(0x188)+'d'){const t=a0n;if(!modules[t(0x1c3)](a))return;const {mod:c}=modules[t(0x1cf)](a);try{typeof c[t(0x17a)+'up']===t(0x18d)+t(0x140)&&(await c[t(0x17a)+'up'](),debug(t(0x17f)+t(0x173)+t(0x18e)+t(0x191)+t(0x182)+c[t(0x17b)]));}catch(d){error(t(0x17f)+t(0x173)+t(0x162)+t(0x1a7)+t(0x1db)+t(0x1bb)+'p\x20'+c[t(0x17b)]+':\x20'+d[t(0x151)+'ge'],sanitizeError(d));}finally{modules[t(0x1aa)+'e'](a),info(t(0x17f)+t(0x173)+t(0x130)+t(0x143)+'d\x20'+c[t(0x17b)]+'\x20('+b+')');}}async function loadFile(a,b=![]){const u=a0n,c=a0c[u(0x168)](AUX_DIR,a),d=a0c[u(0x1b2)+u(0x142)](a,u(0x177));try{const f=await stat(c);if(!f[u(0x170)+'e']())return![];if(b&&modules[u(0x1c3)](d)){const {mod:j}=modules[u(0x1cf)](d);typeof j[u(0x1d7)+u(0x17d)+'ad']===u(0x18d)+u(0x140)&&await j[u(0x1d7)+u(0x17d)+'ad']();}const g=pathToFileURL(c)[u(0x1a8)]+u(0x1b1)+Date[u(0x1b6)](),h=await import(g);if(!validateModule(h,a))return warn(u(0x17f)+u(0x173)+u(0x167)+u(0x1d5)+u(0x127)+u(0x183)+u(0x1be)+u(0x136)+a),![];const i=h[u(0x17b)]||d;return b&&modules[u(0x1c3)](d)&&await unloadModule(d,u(0x1d7)+u(0x19d)+u(0x1a6)),typeof h[u(0x19e)+u(0x1a5)]===u(0x18d)+u(0x140)&&await timeout(h[u(0x19e)+u(0x1a5)](),LOAD_TIMEOUT,i),modules[u(0x16b)](d,{'mod':h,'priority':h[u(0x1c1)+u(0x1cd)]||0x0}),moduleStatus[u(0x143)+'d']=moduleStatus[u(0x143)+'d'][u(0x19f)+'r'](k=>k[u(0x17b)]!==i),moduleStatus[u(0x143)+'d'][u(0x1a0)]({'name':i,'version':h[u(0x13d)+'on']||'?','file':a,'loadedAt':Date[u(0x1b6)]()}),info(u(0x17f)+u(0x173)+'\x20'+(b?u(0x156)+u(0x1ac):u(0x153)+u(0x190))+'\x20'+i+'\x20v'+(h[u(0x13d)+'on']||'?')),!![];}catch(k){const l=b?u(0x188)+'d':u(0x147);return error(u(0x17f)+u(0x173)+u(0x162)+u(0x1a7)+u(0x15c)+l+'\x20'+d+':\x20'+k[u(0x151)+'ge'],sanitizeError(k)),moduleStatus[u(0x13e)+'d'][u(0x1a0)]({'file':a,'error':k[u(0x151)+'ge'],'timestamp':Date[u(0x1b6)]()}),modules[u(0x1aa)+'e'](d),![];}finally{updateHandlers();}}async function loadAllModules(){const v=a0n;moduleStatus[v(0x143)+'d']=[],moduleStatus[v(0x13e)+'d']=[],await mkdir(AUX_DIR,{'recursive':!![]});const a=(await readdir(AUX_DIR))[v(0x19f)+'r'](g=>g[v(0x174)+v(0x14c)](v(0x177))),b=a[v(0x16e)](g=>concurrencyLimiter(()=>loadFile(g,![]))),c=await Promise[v(0x1d1)+v(0x1a4)](b),d=c[v(0x19f)+'r'](f=>f[v(0x176)+'s']===v(0x181)+v(0x195)&&f[v(0x1d4)])[v(0x1b7)+'h'],e=c[v(0x1b7)+'h']-d;return info(v(0x17f)+v(0x173)+v(0x15d)+v(0x1c5)+v(0x159)+v(0x17c)+d+(v(0x1c4)+v(0x158)+',\x20')+e+(v(0x175)+'ed')),moduleStatus[v(0x15a)+v(0x1bd)]=Date[v(0x1b6)](),{'success':d,'failed':e};}async function reloadAllModules(){const w=a0n;if(isReloading){warn(w(0x17f)+w(0x173)+w(0x14d)+w(0x179)+w(0x188)+w(0x149)+w(0x12a)+w(0x1d2)+w(0x1ba)+'s');return;}try{isReloading=!![],info(w(0x17f)+w(0x173)+w(0x129)+w(0x1dc)+w(0x1b8)+w(0x13a)+w(0x1b3)+w(0x1bd));const a=[...modules[w(0x16f)]()];return await Promise[w(0x1d1)+w(0x1a4)](a[w(0x16e)](b=>unloadModule(b,w(0x124)+w(0x188)+'d'))),modules[w(0x13b)](),updateHandlers(),await loadAllModules();}catch(b){error(w(0x17f)+w(0x173)+w(0x1bc)+w(0x185)+w(0x192)+w(0x13c)+w(0x1ab)+w(0x188)+'d:',sanitizeError(b));}finally{isReloading=![];}}function setupWatcher(){const x=a0n;if(watcher)watcher[x(0x1c8)]();watcher=a0d[x(0x171)](AUX_DIR,{'ignoreInitial':!![],'persistent':!![],'awaitWriteFinish':{'stabilityThreshold':0xc8,'pollInterval':0x64}}),watcher['on'](x(0x144),(a,b)=>{const y=x;if(!b[y(0x174)+y(0x14c)](y(0x177)))return;const c=a0c[y(0x1b2)+y(0x142)](b),d=a+'-'+b;if(fileTimers[y(0x1c3)](d))clearTimeout(fileTimers[y(0x1cf)](d));fileTimers[y(0x16b)](d,setTimeout(()=>{const z=y;fileTimers[z(0x1aa)+'e'](d);if(a===z(0x132)+'k')unloadModule(c[z(0x15f)+'ce'](/\.js$/,''));else[z(0x137),z(0x1de)+'e'][z(0x1c6)+z(0x1b5)](a)&&concurrencyLimiter(()=>loadFile(c,!![]));},RELOAD_DEBOUNCE));}),info(x(0x17f)+x(0x173)+x(0x1cc)+x(0x180)+'g\x20'+AUX_DIR+(x(0x146)+x(0x1de)+'es'));}export async function initialize(){const B=a0n;if(isInitialized)return;isInitialized=!![];try{await loadAllModules(),setupWatcher(),hotReloadConfig(()=>{const A=a0b;info(A(0x17f)+A(0x173)+A(0x18c)+A(0x1d6)+A(0x1d8)+A(0x1de)+A(0x17c)+A(0x188)+A(0x16d)+A(0x1be)+'es'),concurrencyLimiter(()=>reloadAllModules());}),info(B(0x17f)+B(0x173)+B(0x1c0)+B(0x164)+B(0x139));}catch(a){error(B(0x17f)+B(0x173)+B(0x1c7)+B(0x164)+B(0x131)+B(0x1ca)+B(0x126)+'\x20'+a[B(0x151)+'ge'],sanitizeError(a)),isInitialized=![];}}function a0b(a,b){const c=a0a();return a0b=function(d,e){d=d-0x124;let f=c[d];if(a0b['gvsLYl']===undefined){var g=function(l){const m='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let n='',o='';for(let p=0x0,q,r,s=0x0;r=l['charAt'](s++);~r&&(q=p%0x4?q*0x40+r:r,p++%0x4)?n+=String['fromCharCode'](0xff&q>>(-0x2*p&0x6)):0x0){r=m['indexOf'](r);}for(let t=0x0,u=n['length'];t<u;t++){o+='%'+('00'+n['charCodeAt'](t)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(o);};a0b['epTnqN']=g,a=arguments,a0b['gvsLYl']=!![];}const h=c[0x0],i=d+h,j=a[i];return!j?(f=a0b['epTnqN'](f),a[i]=f):f=j,f;},a0b(a,b);}export async function cleanup(){const C=a0n;watcher&&(watcher[C(0x1c8)](),watcher=null);const a=[...modules[C(0x16f)]()];await Promise[C(0x144)](a[C(0x16e)](b=>unloadModule(b,C(0x194)+C(0x148)))),modules[C(0x13b)](),updateHandlers(),isInitialized=![],info(C(0x17f)+C(0x173)+C(0x125)+C(0x155)+C(0x134)+C(0x189));}export async function onMessage(a){const D=a0n;for(const {handler:b,module:c}of messageHandlers){try{await b(a);}catch(d){error(D(0x17f)+D(0x173)+D(0x12b)+D(0x166)+D(0x19c)+c+(D(0x175)+D(0x165)+D(0x16c)+D(0x1bf))+d[D(0x151)+'ge'],sanitizeError(d));}}}export async function onCallbackQuery(a){const E=a0n;for(const {handler:b,module:c}of callbackHandlers){try{await b(a);}catch(d){error(E(0x17f)+E(0x173)+E(0x12b)+E(0x166)+E(0x19c)+c+(E(0x175)+E(0x165)+E(0x19b)+E(0x12d)+'\x20')+d[E(0x151)+'ge'],sanitizeError(d));}}}