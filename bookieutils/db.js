const a0r=a0b;function a0a(){const u=['qsbXDwK','y2vPDMu','B25Uzwm','Dw5ZAgK','qMf0y2G','uKfcsuW','ignYzwe','nZjxsg5JDeS','B3DUigu','yxnLlq','DhKGAxm','zwqGBg8','qsbJywm','x2nOzwm','mJG0ndC3B2DOyNzH','icaGicK','AwqSiha','ufjbr00','zurPCLm','yxnL','rgf0ywi','qsb1C2u','qsbQB3u','CNvU','zgLJigy','AcbLCNi','igzSDxm','wsblrvK','BIbLCNi','DgvNCMK','rejFuee','Axn0CYa','Bgv2zwW','ifrsqu4','ihjLBwe','psaXoW','AwqGsu4','icbduKu','ywjHC2u','rvHuifa','zYbKyxq','AgvFC2K','C2XPy2u','ihDPDgG','ywLSzwq','y2HLy2S','y2XVC2u','DgLVBIa','Aw5PBMC','zw91Dca','x2LKieK','AxqGzxi','u0Lhveu','y2HYB24','psbptJS','CM5HBf8','ihzHBhu','DxnLCL8','CMvZB2W','wfqScIa','DxnOigy','Aw50zwC','A3bVAw4','qvrfifq','BgvKoIa','ihvZzxi','igzHAwW','CYaGica','EMuGpsa','Bw9KDwW','Cgf0Aeu','icaGigS','mti1nZG3AurSze5X','Ev9JAgu','BMzYywm','B2DZicG','B3i6ia','rMX1C2G','ig5HBwu','qsbZEw4','y3DK','CgHYyxm','u0fdveK','zsburvG','Dg9ju08','mZaWodyXwePdBhbu','tufswsa','ig1Vzhu','z2v0','uLKGs0u','oWOGica','z2uGveu','zw5ZDxi','pYWGpYK','zdOG','icaGifq','zxrHicG','vevyvca','ufjjtue','BguGifq','mZi1mdKXmgXKB1b1Aa','ugvYAw8','wsWkica','tKnbveu','vhjHBNm','reiGAw4','zsaGveu','icGkica','tK9stue','CMfKzwq','ywWGzMW','u1rtig0','kaOGica','psbxquW','yxqG','ywnRDxa','uGOGica','mNDxEK9pDW','svPf','yxnLigi','sw50zwC','lcbTzxm','laOGica','BML0Awe','ifzbtfu','B25Jzq','yMLSAxq','zxjZAw8','qunloW','zcaTigm','DMvSica','wfqkica','zwq6ia','ndmYtejsvgvi','qujmrsa','icaPoWO','Bg9ZAw4','suyGtK8','zwfKEsa','C2LVBG','DwvKia','vcbjtLq','A2v5CYa','y2S7','u3rYAw4','igr1CMe','rLvmta','ChjLCge','BM93','igrHDge','zw50CMK','CMfUzg8','zxKGica','icaGihq','icaGBgu','lca/lca','Aw5Nia','tLrfr0u','Bg9JA2W','qMfJA3u','yxnLlMq','C3vLCZO','BhvZAca','ic0Gy2W','mJGZndfot2L3tu0','zxHLyW','C2LVBIa','DMvYC2K','Ev90Aw0','tYbSB2C','CMLLCW','su5trvi','uKLnqvi','BIaX','qsbMB3i','DgLVBNm','zwLNBL8','ruDfuIa','u1rtigi','lcbTB2q','Bw9Kzsa','twLNCMe','C2fNzsK','ndKZnMnxyLLkBW','s0vzicG','zYbLBNq','u1rtigm','igXVzYa','uK0GCMu','BgL6zwq','y2TFy2G','CxvPy2S','CM9YoIa','cIaGica','EgLZDhm','vcbYzwm','svrz','DcHuuLu','lteWmda','BgvUz3q','yxnLigm','C3bSAwm','DwXLlca','zMLUywW','icbquKK','yxnLigK','ihrZica','icbjtLq','t047','u2nOzw0','CNjVCJO','ChvZAa','yMfZzq','uMvXDwu','vcbfweK','u2H1Dgq','u0Lhsu4','zxHPDa','ifrfwfq','mda7','DgvKige','q09ntuK','qsb3ywW','sw5PDgK','CcbMywK','CYaODhm','zgf0ywi','u1rtigK','vevhrvi','B3vZid0','y29WEq','zwL2zwq','ywn0Aw8','AgLNAa','lMjHAW','rvmGkd8','zwDYAxq','mtzIswnqrhG','qsbPBNq','uIWkica','Ew5J','y2f0y2G','AxPL','B3nPBMC','vaOGica','qsbIDxm','zwnRoW','zMfPBgu','u1rtigW','venix1m','rejFqKe','zxmUlI4','ysb1CgC','psaXmda','y2HHDf8','icaGieK','icaGica','mZm0mtv2ue5czfe','rejFrfu','CL92zxi','AhjHC2u','BwvZC2e','uK9mtei','icaGktS','kqOGica','CML0Ev8','nZe0z0TwB0HH','qKvhsu4','icaGia','AM9PBG','ihrVihy','rvHulaO','CML0Esa','yxnLihi'];a0a=function(){return u;};return a0a();}(function(a,b){const h=a0b,c=a();while(!![]){try{const d=parseInt(h(0x106))/0x1*(-parseInt(h(0x16d))/0x2)+-parseInt(h(0x140))/0x3*(parseInt(h(0xd3))/0x4)+-parseInt(h(0xe7))/0x5*(parseInt(h(0xff))/0x6)+-parseInt(h(0xf0))/0x7*(-parseInt(h(0x1af))/0x8)+parseInt(h(0x19c))/0x9+-parseInt(h(0x15c))/0xa+-parseInt(h(0x14d))/0xb*(-parseInt(h(0x17d))/0xc);if(d===b)break;else c['push'](c['shift']());}catch(e){c['push'](c['shift']());}}}(a0a,0x2f2d7));import a0c from'sqlite3';import{open}from'sqlite';import a0d from'fs-extra';import a0e from'path';import{getConfig}from'./config.js';import{info,error,warn}from'./logger.js';let db,dbReady=![],writeQueue=[],isFlushing=![],flushTimer;export async function initializeDatabase(){const i=a0b;try{const a=getConfig(),b=a0e[i(0x132)+'ve'](process[i(0x148)](),a[i(0x116)+'TH']);a0d[i(0x154)+i(0x10a)+i(0xd6)](b);const c=a0e[i(0xf3)](b,i(0xc8)+i(0x198)+'b'),d=a0e[i(0xf3)](b,i(0xc8)+i(0x101)+new Date()[i(0x14c)+i(0x188)+'g']()[i(0x122)](0x0,0xa)+i(0xd0));db=await open({'filename':c,'driver':a0c[i(0x10c)+i(0x10b)]}),await db[i(0x19d)](i(0x109)+i(0x10e)+i(0x12f)+i(0x1ac)+i(0x169)+';'),await db[i(0x19d)](i(0x109)+i(0x104)+i(0x121)+i(0x13c)+i(0xac)+i(0xc1)),await db[i(0x19d)](i(0x109)+i(0x147)+i(0x12d)+i(0xcb)+'\x20'+(a[i(0xe8)+i(0xfd)+i(0xaa)]===i(0xcf)?i(0x18a):i(0x164)+'L')+';'),await db[i(0x19d)](i(0x109)+i(0x1a6)+i(0x1a8)+i(0x186)+i(0x12e)),await db[i(0x19d)](i(0x109)+i(0xdb)+i(0x1a0)+i(0x129)+i(0xe3)+i(0xc1)),info(i(0x10c)+i(0xb3)+i(0x173)+i(0xa3)+i(0x123)+'\x20'+a[i(0xe8)+i(0xfd)+i(0xaa)]+(i(0x189)+i(0x176)+'y')),await db[i(0x19d)](i(0xa7)+i(0x11d)+i(0x137)+i(0x17e)+i(0x181)+i(0xbc)+i(0x167)+i(0x158)+i(0xa7)+i(0x13f)+i(0x190)+i(0x159)+i(0x15a)+i(0x151)+i(0x15e)+i(0xe6)+i(0x130)+i(0x14b)+i(0xda)+i(0xed)+i(0xa7));const e=await db[i(0x150)](i(0x109)+i(0x10d)+i(0xe9)+i(0x183)),f=e[i(0x131)+i(0x19f)+'on']||0x0;f<0x1&&await applyMigrations(),await integrityCheck(),await backupDB(c,d),dbReady=!![],startFlushInterval(a[i(0xe0)+i(0xdf)+i(0x16e)]),info(i(0x10c)+i(0xf7)+i(0x182)+i(0x16a)+c);}catch(g){error(i(0x161)+i(0x12b)+i(0xa6)+g[i(0xeb)+'ge'],g),process[i(0xbf)](0x1);}}async function applyMigrations(){const j=a0b;try{await db[j(0x19d)](j(0xf1)+j(0x119)+j(0x14a)+j(0xb6)),await db[j(0x19d)](j(0xa7)+j(0x11d)+j(0x137)+j(0x17e)+j(0x181)+j(0xbc)+j(0xde)+j(0x143)+j(0xa7)+j(0x191)+j(0x13b)+j(0xb5)+j(0x1a9)+j(0x15a)+j(0x151)+j(0x15e)+j(0xe6)+j(0x14f)+j(0x15b)+j(0xf5)+j(0xe6)+j(0x192)+j(0x17a)+j(0xc0)+j(0x172)+j(0xe6)+j(0xeb)+j(0x153)+j(0x17b)+j(0x107)+j(0x152)+'\x20'),await db[j(0x19d)](j(0xa7)+j(0x11d)+j(0x137)+j(0x17e)+j(0x181)+j(0xbc)+j(0x1aa)+j(0x196)+j(0x117)+j(0x168)+j(0xe6)+j(0xe4)+j(0x11c)+j(0xca)+j(0x172)+j(0xe6)+j(0x149)+j(0x162)+j(0x133)+j(0xe6)+j(0xb2)+j(0x14e)+j(0x1b0)+j(0xe4)+j(0x108)+j(0xea)+j(0xee)+j(0xed)+j(0xa7)),await db[j(0x19d)](j(0xa7)+j(0x11d)+j(0x137)+j(0x17e)+j(0x181)+j(0xbc)+j(0xa0)+j(0xfa)+j(0x1a7)+j(0x163)+j(0xe6)+j(0x146)+j(0x157)+j(0x11f)+j(0x1a4)+j(0x113)+j(0x172)+j(0xe6)+j(0xe4)+j(0x11c)+j(0xca)+j(0xa7)+j(0x17f)+j(0xf2)),await db[j(0x19d)](j(0xa7)+j(0x11d)+j(0x137)+j(0x17e)+j(0x181)+j(0xbc)+j(0xc9)+j(0x142)+j(0x1a7)+j(0x163)+j(0xe6)+j(0x139)+j(0x12a)+j(0x195)+j(0xd5)+j(0xe6)+j(0xb4)+j(0xe5)+j(0x195)+j(0x16c)+j(0xed)+j(0xa7)),await db[j(0x19d)](j(0x109)+j(0x10d)+j(0xe9)+j(0x19e)+j(0x11b)),await db[j(0x19d)](j(0xc3)+'T;'),info(j(0xb7)+j(0xe2)+j(0x165)+j(0xf4)+j(0x177)+j(0x1a5));}catch(a){await db[j(0x19d)](j(0xec)+j(0x178)),error(j(0x1ad)+j(0x127)+j(0xdd)+j(0x156)+a[j(0xeb)+'ge'],a);throw a;}}async function integrityCheck(){const k=a0b;try{const a=await db[k(0x150)](k(0x109)+k(0xf8)+k(0xa4)+k(0xdc));if(a[k(0xa5)+k(0x105)+'k']!=='ok'){const b=await db[k(0x150)](k(0x109)+k(0xd4)+k(0xd2)+k(0x141)+k(0x187));throw new Error(k(0x161)+k(0x115)+k(0x102)+k(0x199)+'\x20'+b[k(0x135)+k(0xef)+k(0x125)]);}}catch(c){error(k(0x170)+k(0xf6)+k(0x125)+k(0x13a)+k(0x17c)+c[k(0xeb)+'ge'],c);throw c;}}async function backupDB(a,b){const l=a0b;try{await a0d[l(0x13e)+l(0xa8)](a)&&(await a0d[l(0xcc)](a,b),info(l(0x10c)+l(0x16f)+l(0x16b)+l(0xfe)+l(0xc2)+'t\x20'+b));}catch(c){error(l(0x197)+l(0xc6)+l(0x138)+c[l(0xeb)+'ge'],c);}}function startFlushInterval(a){const m=a0b;writeQueue[m(0xad)+'h']>=a&&flushQueue(a)[m(0xd7)](()=>error(m(0xc5)+m(0x166)+m(0x134)+m(0x124))),flushTimer=setInterval(()=>{const n=m;writeQueue[n(0xad)+'h']>0x0&&flushQueue(a)[n(0xd7)](()=>error(n(0x15d)+n(0x110)+n(0x19a)+n(0xdd)+'d'));},0x1388);}export function logToDB(a,b,c){const o=a0b;if(!dbReady)return;writeQueue[o(0xb9)]({'ts':Date[o(0x18c)](),'module':a,'level':b,'message':c[o(0x122)](0x0,0x3e8)});const d=getConfig();writeQueue[o(0xad)+'h']>=d[o(0xe0)+o(0xdf)+o(0x16e)]&&flushQueue(d[o(0xe0)+o(0xdf)+o(0x16e)])[o(0xd7)](()=>error(o(0xfc)+o(0x112)+o(0x111)+'or'));}function a0b(a,b){const c=a0a();return a0b=function(d,e){d=d-0x9f;let f=c[d];if(a0b['kphOMK']===undefined){var g=function(l){const m='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let n='',o='';for(let p=0x0,q,r,s=0x0;r=l['charAt'](s++);~r&&(q=p%0x4?q*0x40+r:r,p++%0x4)?n+=String['fromCharCode'](0xff&q>>(-0x2*p&0x6)):0x0){r=m['indexOf'](r);}for(let t=0x0,u=n['length'];t<u;t++){o+='%'+('00'+n['charCodeAt'](t)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(o);};a0b['gYjmMW']=g,a=arguments,a0b['kphOMK']=!![];}const h=c[0x0],i=d+h,j=a[i];return!j?(f=a0b['gYjmMW'](f),a[i]=f):f=j,f;},a0b(a,b);}async function flushQueue(a){const p=a0b;if(!dbReady||isFlushing)return;isFlushing=!![];const b=writeQueue[p(0xaf)+'e'](0x0,a);if(b[p(0xad)+'h']===0x0){isFlushing=![];return;}const c=[];let d;try{await db[p(0x19d)](p(0xf1)+p(0x119)+p(0x14a)+p(0xb6)),d=await db[p(0x18b)+'re'](p(0x1a3)+p(0x185)+p(0x1a1)+p(0xc7)+p(0x1ab)+p(0xb0)+p(0x118)+p(0x171)+p(0x1ae)+p(0x174)+p(0xd1)+p(0x193)+p(0x155));for(const e of b){try{await d[p(0x10f)](e['ts'],e[p(0x13d)+'e'],e[p(0x118)],e[p(0xeb)+'ge']);}catch{c[p(0xb9)](e);}}await d[p(0xb1)+p(0xd8)](),await db[p(0x19d)](p(0xc3)+'T;'),Math[p(0x18f)+'m']()<0.1&&await db[p(0x19d)](p(0x109)+p(0xc4)+p(0x105)+p(0x136)+p(0xab)+p(0x15f)+');');}catch(f){error(p(0x160)+p(0xce)+p(0x114)+p(0x144)+f[p(0xeb)+'ge'],f),await db[p(0x19d)](p(0xec)+p(0x178)),c[p(0xb9)](...b);}finally{if(d)try{await d[p(0xb1)+p(0xd8)]();}catch{}c[p(0xad)+'h']>0x0&&(writeQueue[p(0xfb)+'ft'](...c),warn(p(0xbb)+p(0x184)+c[p(0xad)+'h']+(p(0x13a)+p(0x103)+p(0x9f)+p(0x1a2)))),isFlushing=![];}}async function gracefulClose(){const q=a0b;try{clearInterval(flushTimer);const a=getConfig();writeQueue[q(0xad)+'h']>0x0&&(info(q(0x145)+q(0x194)+writeQueue[q(0xad)+'h']+(q(0x11a)+q(0x128)+q(0xa1)+q(0x18e)+q(0xe1))),await flushQueue(a[q(0xe0)+q(0xdf)+q(0x16e)])),db&&(await db[q(0x126)](),info(q(0x10c)+q(0xae)+q(0xfa)+q(0x127)+q(0x126)+'d'));}catch(b){error(q(0xbd)+q(0x100)+q(0xb8)+'\x20'+b[q(0xeb)+'ge'],b);}}process[a0r(0x175)](a0r(0xbe)+'T',()=>{const s=a0r;info(s(0xbe)+s(0xa9)+s(0xcd)+s(0x19b)+s(0xd9)+s(0x18d)+s(0xba)),gracefulClose()[s(0xb1)+'ly'](()=>process[s(0xbf)](0x0));}),process[a0r(0x175)](a0r(0x12c)+'RM',()=>{const t=a0r;info(t(0x12c)+t(0xa2)+t(0xf9)+t(0x179)+t(0x180)+t(0x120)+t(0x11e)),gracefulClose()[t(0xb1)+'ly'](()=>process[t(0xbf)](0x0));});export{db};